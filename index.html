<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>보일러 예약 계산기 (Android용)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA 관련 메타 -->
  <meta name="theme-color" content="#ffffff" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="보일러 예약" />

  <!-- 홈 화면 아이콘 / PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest" />
  <!-- 아이콘은 나중에 실제 png 파일로 교체 가능 -->
  <link rel="icon" sizes="192x192" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    body {
      font-family: sans-serif;
      margin: 16px;
      line-height: 1.4;
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 4px;
      padding: 6px;
      font-size: 1rem;
    }
    button {
      margin-top: 16px;
    }
    textarea {
      height: 180px;
      resize: vertical;
    }

    .footer {
      margin-top: 16px;
      font-size: 0.8rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>보일러 예약 시작 시간 계산기</h1>

  <!-- 예약 OFF 시간 (N시간) 선택 -->
  <label for="offDuration">예약 시간 (OFF 시간)</label>
  <select id="offDuration">
    <option value="30">30분</option>
    <option value="60">1시간</option>
    <option value="120">2시간</option>
    <option value="180">3시간</option>
    <option value="240">4시간</option>
  </select>

  <!-- 보일러가 실제로 켜지기 시작하는 목표 ON 시각 -->
  <label for="targetOn">보일러를 켜고 싶은 특정 시간</label>
  <input type="datetime-local" id="targetOn">

  <!-- 검색을 언제부터 할지: 예약 기능을 켜는 시작 시각의 검색 범위 시작 -->
  <label for="searchFrom">언제부터 예약 시간을 계산할까요?</label>
  <input type="datetime-local" id="searchFrom">

  <button id="calcButton">계산하기</button>

  <label for="result">결과 (예약 기능을 켜야 하는 시각들)</label>
  <textarea id="result" readonly></textarea>

  <div class="footer">
    이 페이지를 Chrome에서 열고 메뉴 &gt; "홈 화면에 추가"를 선택하세요.
  </div>

  <script>
    function calculate() {
      const offMinutes = parseInt(document.getElementById("offDuration").value, 10);
      const targetOnStr = document.getElementById("targetOn").value;
      const searchFromStr = document.getElementById("searchFrom").value;
      const resultArea = document.getElementById("result");

      // 입력값 체크
      if (!targetOnStr || !searchFromStr) {
        resultArea.value = "⚠️ 보일러 ON 시작 시각과 검색 시작 시간을 모두 입력하세요.";
        return;
      }

      const targetOn = new Date(targetOnStr);
      const searchFrom = new Date(searchFromStr);

      if (searchFrom > targetOn) {
        resultArea.value = "⚠️ 검색 시작 시간이 목표 ON 시각보다 늦을 수 없습니다.";
        return;
      }

      const CYCLE_MINUTES = 20 + offMinutes; // 20분 ON + N분 OFF
      const cycleMs = CYCLE_MINUTES * 60 * 1000;

      let current = new Date(searchFrom.getTime());
      const results = [];

      while (current <= targetOn) {
        const diffMs = targetOn - current;
        if (diffMs >= 0 && diffMs % cycleMs === 0) {
          results.push(formatDateTime(current));
        }
        // 1분 단위로 증가
        current = new Date(current.getTime() + 60 * 1000);
      }

      if (results.length === 0) {
        resultArea.value = "조건에 맞는 예약 시작 시간이 없습니다.";
      } else {
        let text = "";
        text += "총 " + results.length + "개의 예약 시작 시각이 있습니다.\n\n";
        results.forEach((t, idx) => {
          text += (idx + 1) + ") " + t + "\n";
        });
        resultArea.value = text;
      }
    }

    function formatDateTime(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      const hh = String(date.getHours()).padStart(2, "0");
      const mm = String(date.getMinutes()).padStart(2, "0");
      return y + "-" + m + "-" + d + " " + hh + ":" + mm;
    }

    // 버튼 이벤트
    document.getElementById("calcButton").addEventListener("click", calculate);

    // 서비스워커 등록 (PWA 필수)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker.register("service-worker.js")
          .catch(function (err) {
            console.log("Service Worker 등록 오류:", err);
          });
      });
    }
  </script>
</body>
</html>

